import java.util.ArrayList;
import java.util.InputMismatchException;
import java.util.List;
import java.util.Scanner;

public class Service {
    List<Character> characters = new ArrayList<Character>();
    Character currentCharacter = null;

    void newCharacter(){
        Character character = new Character().chooseCharacter();
        characters.add(character);
        currentCharacter = character;
    }

    void getInfo(Character character){
        character.getInfo();
        System.out.println("Level: " + character.level);
        System.out.println("Exp: " + character.exp);
        System.out.println("Gold: " + character.gold);
    }

    void viewAllCharacters(){
        if(characters.isEmpty()){
            System.out.println("‚ùå No characters.");
            return;
        }
        for(Character character: characters){
            getInfo(character);
            System.out.println();
        }
    }

    void chooseCurrentCharacter() {
        Scanner scanner = new Scanner(System.in);

        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }

        System.out.println("\nüéÆ Choose your character:");
        for (int i = 0; i < characters.size(); i++) {
            Character c = characters.get(i);
            String type = c.getClass().getSimpleName();
            String emoji = switch (type) {
                case "Mage" -> "üßô";
                case "Archer" -> "üèπ";
                default -> "‚öîÔ∏è";
            };

            System.out.println(i + ") " + emoji + " " + c.name + " - ‚ù§Ô∏è " + c.health + " HP");
        }

        int choice = -1;
        while (choice < 0 || choice >= characters.size()) {
            System.out.print("Enter the number of the character you want to play with: ");
            try {
                choice = scanner.nextInt();
            } catch (InputMismatchException e) {
                scanner.nextLine(); // clean buffer
                System.out.println("‚ùó Please enter a valid number.");
                return;
            }
        }

        currentCharacter = characters.get(choice);
        System.out.println("‚úÖ You selected: " + currentCharacter.name + " the " + currentCharacter.getClass().getSimpleName() + "!");
    }

    void upgradeWeapon() {
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        if(currentCharacter.weapon != null){
            System.out.println("Choose option:");
            System.out.println("1) Level up your weapon");
            System.out.println("2) Enhance your weapon");

            Scanner scanner = new Scanner(System.in);
            int opt = scanner.nextInt();

            switch (opt) {
                case 1 -> {
                    currentCharacter.attack -= currentCharacter.weapon.getDamage();
                    currentCharacter.upgradeWeapon();
                    currentCharacter.attack += currentCharacter.weapon.getDamage();
                }
                case 2 ->{
                    switch (currentCharacter){
                        case Mage _ -> {
                            currentCharacter.attack -= currentCharacter.weapon.getDamage();
                            ((Mage) currentCharacter).enhanceGrimoire();
                            currentCharacter.attack += currentCharacter.weapon.getDamage();
                        }
                        case Archer _ -> {
                            currentCharacter.attack -= currentCharacter.weapon.getDamage();
                            ((Archer) currentCharacter).enhanceBow();
                            currentCharacter.attack += currentCharacter.weapon.getDamage();
                        }
                        default -> {
                            currentCharacter.attack -= currentCharacter.weapon.getDamage();
                            ((Warrior) currentCharacter).enhanceSword();
                            currentCharacter.attack += currentCharacter.weapon.getDamage();
                        }
                    }
                }
            }
        }else {
            System.out.println("You have no weapon equipped.");
        }
    }

    void viewInventory(){
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        currentCharacter.showInventory();
    }

    void equipWeapon() {
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        ArrayList<Item> items = currentCharacter.inventory.getItems();
        List<Weapon> weapons = new ArrayList<>();

        if (items.isEmpty()) {
            System.out.println("You have no weapons to equip!");
            return;
        }

        for (int i = 0; i < items.size(); i++) {
            Item currentItem = items.get(i);
            if (currentItem instanceof Weapon wp) {
                weapons.add(wp);
                System.out.println(i + ": " + wp.name + ", damage: " + wp.getDamage() + ", level: " + wp.getLevel()
                        + ", value: " + wp.getValue());
            }
        }

        if (weapons.isEmpty()) {
            System.out.println("‚ùå No weapons found in your inventory.");
            return;
        }

        System.out.println("üõ°Ô∏è Choose a weapon to equip (enter the index):");
        Scanner scanner = new Scanner(System.in);
        int index = scanner.nextInt();

        if (index < 0 || index >= items.size() || !(items.get(index) instanceof Weapon selectedWeapon)) {
            System.out.println("‚ùå Invalid selection.");
            return;
        }

        if(selectedWeapon.use(currentCharacter) == 0) {
            currentCharacter.inventory.removeItem(selectedWeapon);
            System.out.println("‚úÖ Equipped " + selectedWeapon.name + " successfully!");
        }
    }

    void buyHealingPotion() {
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        Scanner scanner = new Scanner(System.in);

        System.out.println("\nüß™ Available Healing Potions:");
        System.out.println("1) Small Potion üß¥ - Cost: 10üí∞, Heal: 5‚ù§Ô∏è, Value: 5");
        System.out.println("2) Medium Potion üß™ - Cost: 15üí∞, Heal: 10‚ù§Ô∏è, Value: 10");
        System.out.println("3) Large Potion üß´ - Cost: 25üí∞, Heal: 20‚ù§Ô∏è, Value: 20");
        System.out.println("0) Cancel");

        System.out.print("Choose a potion to buy (enter the number): ");
        int choice = scanner.nextInt();

        int cost = 0;
        HealthPotion potion = null;

        switch (choice) {
            case 1 -> {
                cost = 10;
                potion = new HealthPotion(5, 5);
            }
            case 2 -> {
                cost = 15;
                potion = new HealthPotion(10, 10);
            }
            case 3 -> {
                cost = 25;
                potion = new HealthPotion(20, 20);
            }
            case 0 -> {
                System.out.println("‚ùå Purchase cancelled.");
                return;
            }
            default -> {
                System.out.println("‚ùå Invalid option.");
                return;
            }
        }

        if (currentCharacter.gold < cost) {
            System.out.println("üí∏ Not enough gold!");
            return;
        }

        currentCharacter.addGold(-cost);
        currentCharacter.inventory.addItem(potion);
        System.out.println("‚úÖ You bought a " + potion.getName() + "! It's been added to your inventory.");
    }

    void buyWeapon(){
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        Scanner scanner = new Scanner(System.in);

        System.out.println("\nüèπ Available Bows:");
        System.out.println("1) Wooden Bow ü™µ - Damage: 5‚öîÔ∏è, Cost: 15üí∞, Value: 10");
        System.out.println("2) Elven Bow üçÉ - Damage: 12‚öîÔ∏è, Cost: 40üí∞, Value 30");
        System.out.println("3) Dragonbone Bow üêâ - Damage: 25‚öîÔ∏è, Cost: 90üí∞, Value: 75");

        System.out.println("\nüó°Ô∏è Available Swords:");
        System.out.println("4) Rusty Sword üß∑ - Damage: 4‚öîÔ∏è, Cost: 12üí∞, Value: 8");
        System.out.println("5) Steel Blade ‚öíÔ∏è - Damage: 11‚öîÔ∏è, Cost: 35üí∞, Value: 25");
        System.out.println("6) Shadowfang üó°Ô∏è - Damage: 24‚öîÔ∏è, Cost: 85üí∞, Value: 60");

        System.out.println("\nüìñ Available Grimoires:");
        System.out.println("7) Torn Grimoire üìú - Spell Power: 6‚ú®, Cost: 16üí∞, Value: 10");
        System.out.println("8) Arcane Codex üìò - Spell Power: 14‚ú®, Cost: 48üí∞, Value: 40");
        System.out.println("9) Necronomicon ‚ò†Ô∏è - Spell Power: 30‚ú®, Cost: 100üí∞, Value: 85");
        System.out.println("0) Cancel");


        System.out.print("Choose a weapon to buy (enter the number): ");
        int choice = scanner.nextInt();

        int cost = 0;
        Weapon weapon = null;

        switch (choice) {
            case 1 -> {
                cost = 15;
                weapon = new Weapon("Wooden Bow", 5, "Bow", 10);
            }
            case 2 -> {
                cost = 40;
                weapon = new Weapon("Elven Bow", 12, "Bow", 30);
            }
            case 3 -> {
                cost = 90;
                weapon = new Weapon("Dragonbone Bow", 25, "Bow", 75);
            }
            case 4 -> {
                cost = 12;
                weapon = new Weapon("Rusty Sword", 4, "Sword", 8);
            }
            case 5 -> {
                cost = 35;
                weapon = new Weapon("Steel Blade", 11, "Sword", 25);
            }
            case 6 -> {
                cost = 85;
                weapon = new Weapon("Shadowfang", 24, "Sword", 60);
            }
            case 7 -> {
                cost = 16;
                weapon = new Weapon("Torn Grimoire", 6, "Grimoire", 10);
            }
            case 8 -> {
                cost = 48;
                weapon = new Weapon("Arcane Codex", 14, "Grimoire", 40);
            }
            case 9 -> {
                cost = 100;
                weapon = new Weapon("Necronomicon", 30, "Grimoire", 85);
            }
            case 0 -> {
                System.out.println("‚ùå Purchase cancelled.");
                return;
            }
            default -> {
                System.out.println("‚ùå Invalid option.");
                return;
            }
        }


        if (currentCharacter.gold < cost) {
            System.out.println("üí∏ Not enough gold!");
            return;
        }

        currentCharacter.addGold(-cost);
        currentCharacter.inventory.addItem(weapon);
        System.out.println("‚úÖ You bought a " + weapon.getName() + "! It's been added to your inventory.");
    }


    void sellItemFromInventory(){
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        Scanner scanner = new Scanner(System.in);
        currentCharacter.showInventory();

        if(!currentCharacter.inventory.getItems().isEmpty()) {
            int index = -1;

            while (index < 0 || index >= currentCharacter.inventory.getItems().size()) {
                System.out.print("üî¢ Choose the index of the item you want to sell (or -1 to cancel): ");
                try {
                    index = scanner.nextInt();
                    if (index == -1) {
                        System.out.println("‚ùå Sell cancelled.");
                        return;
                    }
                } catch (InputMismatchException e) {
                    scanner.nextLine(); // clear buffer
                    System.out.println("‚ùó Please enter a valid number.");
                }
            }
            currentCharacter.sellItem(currentCharacter.inventory.getItems().get(index));
        }
    }

    void newBattle(){
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        Battle battle = new Battle(currentCharacter);
        if(battle.newBattle(currentCharacter) == -1)
            characters.remove(currentCharacter);
    }

    void viewBattleVictories(){
        if (characters.isEmpty()) {
            System.out.println("‚ùå No characters available!");
            return;
        }
        currentCharacter.printBattlesWon();
    }

    void displayBattleTypes() {
        System.out.println("üó∫Ô∏è Available Battle Difficulties:\n");

         System.out.print("üî∏  Super-Easy");
         System.out.println(" - Contents: 1-3 Goblins");

         System.out.print("üî∏  Easy");
         System.out.println(" - Contents: 4-7 Goblins");

         System.out.print("üî∏  Normal");
         System.out.println(" - Contents: 2 Orcs or 1-2 Goblins and 1 Orc");

         System.out.print("üî∏  Hard");
         System.out.println(" - Contents: 2-5 Orcs");

         System.out.print("üî∏  Very-Hard");
         System.out.println(" - Contents: 3 Orcs and 1 Dragon");

         System.out.print("üî∏  Nightmare");
         System.out.println(" - Contents: 2-3 Dragons");
    }

    void getEnemyInfo(){
        new Goblin().getInfo();
        System.out.println();
        new Orc().getInfo();
        System.out.println();
        new Dragon().getInfo();
        System.out.println();
    }

    public void showCharacterInfo() {
        System.out.println("üìú === Character Classes ===");

        // Archer
        System.out.println("\nüèπ Archer:");
        System.out.println(" - Health: 25 ‚ù§Ô∏è");
        System.out.println(" - Attack: 8 ‚öîÔ∏è");
        System.out.println(" - Defense: 6 üõ°Ô∏è");
        System.out.println(" - Energy: 30 ‚ö°");

        System.out.println("üî∏ Abilities:");
        System.out.println("   ‚Ä¢ Double Arrows: consumes 16 energy, doubles attack (damage = " + (8 * 2) + " before defense)");
        System.out.println("   ‚Ä¢ Gain Energy: restores 20 energy");
        System.out.println("   ‚Ä¢ Enhance Bow: +20 damage if you have a 'Rare Gem'");

        // Mage
        System.out.println("\nüßô Mage:");
        System.out.println(" - Health: 20 ‚ù§Ô∏è");
        System.out.println(" - Attack: 10 ‚öîÔ∏è");
        System.out.println(" - Defense: 5 üõ°Ô∏è");
        System.out.println(" - Mana: 30 ‚ú®");

        System.out.println("üî∏ Abilities:");
        System.out.println("   ‚Ä¢ Fire Spell: -10 mana, +5 damage bonus (15 total damage before defense), ineffective vs Dragons");
        System.out.println("   ‚Ä¢ Poison Spell: -12 mana, applies poison (-3 HP for 2 turns), normal attack damage");
        System.out.println("   ‚Ä¢ Gain Mana: restores 20 mana");
        System.out.println("   ‚Ä¢ Enhance Grimoire: +20 damage if you have a 'Rare Gem'");

        // Warrior
        System.out.println("\n‚öîÔ∏è Warrior:");
        System.out.println(" - Health: 30 ‚ù§Ô∏è");
        System.out.println(" - Attack: 5 ‚öîÔ∏è");
        System.out.println(" - Defense: 7 üõ°Ô∏è");
        System.out.println(" - Speed: 30 üåÄ");

        System.out.println("üî∏ Abilities:");
        System.out.println("   ‚Ä¢ Use Speed: consumes 16 speed (attacks for 2 more rounds)");
        System.out.println("   ‚Ä¢ Gain Speed: restores 20 speed");
        System.out.println("   ‚Ä¢ Enhance Sword: +12 damage if you have a 'Dragon Scale'");
    }


}
